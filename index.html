<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Booking Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* prevent horizontal overflow when sidebar collapses */
        }


        /* Sidebar */
        .sidebar {
            width: 280px;
            flex: 0 0 280px; /* stable flex sizing */
            background: #2d3748;
            color: white;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease, width 0.3s ease;
            flex-shrink: 0;
        }


        .sidebar.collapsed {
            width: 0;
            flex: 0 0 0;
            padding: 0;
            overflow: hidden;
        }


        /* Sidebar Toggle Button */
        .sidebar-toggle {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        

        /* Floating toggle when sidebar is collapsed */
        .sidebar-toggle-floating {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1002;
            background: #667eea;
            border-color: #667eea;
            display: none;
        }

        .sidebar-toggle-floating:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        /* Show floating toggle only when sidebar is collapsed */
        .sidebar.collapsed ~ .sidebar-toggle-floating {
            display: flex;
        }
.sidebar.collapsed .sidebar-toggle:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        /* Main Content */
        .main-content {
            flex: 1 1 auto;
            min-width: 0;       /* critical for flex layouts with wide tables */
            display: flex;
            flex-direction: column;
            background: #f7fafc;
            overflow: hidden;   /* let .content-area handle scrolling */
            position: relative;
        }

        .sidebar.collapsed ~ 

        .logo {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #4a5568;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #a0aec0;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .nav-item:hover {
            background: #4a5568;
        }

        .nav-item.active {
            background: #667eea;
        }

        .filter-section {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .filter-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group {
            margin-bottom: 12px;
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 6px;
            color: #cbd5e0;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #2d3748;
            color: white;
            font-size: 13px;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .filter-tag {
            background: #4a5568;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .filter-tag:hover {
            background: #718096;
        }

        .filter-tag.active {
            background: #667eea;
        }

        .clear-filters {
            width: 100%;
            padding: 8px;
            background: #fc8181;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
        }

        .clear-filters:hover {
            background: #f56565;
        }

        /* Main Content */
        

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            font-size: 18px;
            display: none;
        }

        .clear-search.visible {
            display: block;
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: white;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .view-btn {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn.active {
            border-color: #667eea;
            background: #f7fafc;
            color: #667eea;
        }

        .results-info {
            color: #718096;
            font-size: 14px;
        }

        /* Grid View */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .group-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .group-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .group-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .group-name {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .group-id {
            font-size: 12px;
            color: #a0aec0;
        }

        .group-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-1st-dep { background: #feebc8; color: #7c2d12; }
        .status-2nd-dep { background: #fed7d7; color: #742a2a; }
        .status-names { background: #e9d8fd; color: #44337a; }
        .status-tktng { background: #bee3f8; color: #2c5282; }
        .status-complete { background: #c6f6d5; color: #22543d; }

        .invoice-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .invoice-not-issued { background: #e2e8f0; color: #4a5568; }
        .invoice-issued { background: #feebc8; color: #7c2d12; }
        .invoice-loaded { background: #bee3f8; color: #2c5282; }
        .invoice-paid { background: #c6f6d5; color: #22543d; }

        .group-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .meta-item {
            font-size: 13px;
        }

        .meta-label {
            color: #a0aec0;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meta-value {
            color: #2d3748;
            font-weight: 600;
            margin-top: 2px;
        }

        .group-deadlines {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .deadline-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .deadline-ok { background: #e6fffa; color: #234e52; }
        .deadline-warning { background: #fef5e7; color: #7c2d12; }
        .deadline-urgent { background: #fed7d7; color: #742a2a; }

        .group-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .document-count {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #718096;
        }

        .comment-count {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #718096;
        }

        /* Table View */
        .groups-table {
            background: white;
            border-radius: 12px;
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* Scroll indicator */
        .groups-table::after {
            content: '‚Üí';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(to right, transparent, white 30%);
            padding: 10px 20px 10px 40px;
            pointer-events: none;
            font-size: 24px;
            color: #cbd5e0;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .groups-table.has-scroll::after {
            opacity: 1;
        }

        .groups-table table {
            width: max-content;
            border-collapse: collapse;
            min-width: 100%;
        }

        .groups-table th {
            background: #f7fafc;
            padding: 12px 8px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .groups-table th:hover {
            background: #edf2f7;
        }

        .sort-arrow {
            font-size: 10px;
            opacity: 0.5;
            margin-left: 4px;
        }

        .groups-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
        }

        .groups-table tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .groups-table tr:hover {
            background: #f7fafc;
        }

        .deadline-cell {
            position: relative;
        }

        .deadline-input {
            border: 2px solid #3182ce;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            width: 120px;
            outline: none;
        }

        .deadline-display {
            display: inline-block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #a0aec0;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f7fafc;
            color: #4a5568;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-tabs {
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 25px;
        }

        .modal-tab {
            padding: 12px 0;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .modal-tab:hover {
            color: #4a5568;
        }

        .modal-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
        }

        /* Documents Section */
        .documents-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .document-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .document-item:hover {
            border-color: #cbd5e0;
        }

        .document-icon {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: #718096;
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #718096;
        }

        .icon-btn:hover {
            background: #e2e8f0;
            color: #2d3748;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .upload-area.dragging {
            border-color: #667eea;
            background: #ebf4ff;
        }

        /* Comments Section */
        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .comment-item {
            display: flex;
            gap: 12px;
        }

        .comment-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .comment-author {
            font-weight: 600;
            color: #2d3748;
        }

        .comment-time {
            font-size: 12px;
            color: #a0aec0;
        }

        .comment-text {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            font-size: 13px;
        }

        .comment-action {
            color: #718096;
            cursor: pointer;
            transition: color 0.2s;
        }

        .comment-action:hover {
            color: #667eea;
        }

        .comment-form {
            display: flex;
            gap: 12px;
        }

        .comment-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .comment-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Activity Log */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .activity-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .activity-icon.edit { background: #bee3f8; color: #2c5282; }
        .activity-icon.upload { background: #c6f6d5; color: #22543d; }
        .activity-icon.comment { background: #e9d8fd; color: #44337a; }
        .activity-icon.deadline { background: #fed7d7; color: #742a2a; }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            color: #2d3748;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: #a0aec0;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-delete {
            background: #fc8181;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-delete:hover {
            background: #f56565;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .notification-banner {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 999px;
            margin: 0;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            width: auto;
            max-width: 100%;
        }

        .notification-banner.enabled {
            background: #f0fff4; /* very subtle */
            border-color: #c6f6d5;
        }

        .status-row {
            padding: 12px 30px 0 30px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .banner-left {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }

        .banner-text {
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
        }

        .chip-btn {
            padding: 6px 10px !important;
            font-size: 12px !important;
            border-radius: 999px !important;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .groups-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <span>‚úàÔ∏è Group Booking Manager</span>
                <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">
                    ‚ò∞
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Views</div>
                <div class="nav-item active" data-view="all">
                    <span>üìã</span> All Groups
                </div>
                <div class="nav-item" data-view="1st-dep">
                    <span>üí∞</span> 1st Deposit
                </div>
                <div class="nav-item" data-view="2nd-dep">
                    <span>üí≥</span> 2nd Deposit
                </div>
                <div class="nav-item" data-view="names">
                    <span>üìù</span> Names
                </div>
                <div class="nav-item" data-view="tktng">
                    <span>üé´</span> Ticketing
                </div>
                <div class="nav-item" data-view="complete">
                    <span>‚úÖ</span> Complete
                </div>
                <div class="nav-item" data-view="due-this-week">
                    <span>‚è∞</span> Due This Week
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-title">üîç Filters</div>
                
                <div class="filter-group">
                    <label>Date Range</label>
                    <select id="dateRangeFilter">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Airline</label>
                    <input type="text" id="airlineFilter" placeholder="Filter by airline...">
                </div>

                <div class="filter-group">
                    <label>Team</label>
                    <select id="teamFilter">
                        <option value="">All Teams</option>
                    </select>
                </div>

                <button class="clear-filters" onclick="clearAllFilters()">Clear All Filters</button>
            </div>
        </aside>

        <!-- Floating Sidebar Toggle (visible when sidebar is collapsed) -->
        <button class="sidebar-toggle sidebar-toggle-floating" id="sidebarToggleFloating" onclick="toggleSidebar()" title="Open sidebar">
            ‚ò∞
        </button>


        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="globalSearch" placeholder="Search groups, airlines, dates, notes...">
                    <button class="clear-search" onclick="clearSearch()">√ó</button>
                </div>
                <div class="top-bar-actions">
                    <button class="btn-secondary" chip-btn onclick="importData()">üì• Import</button>
                    <button class="btn-secondary" onclick="exportData()">üìä Export</button>
                    <button class="btn-primary" onclick="createNewGroup()">
                        <span>+</span> New Group
                    </button>
                </div>
            </div>

            <!-- Status Row (compact) -->
            <div class="status-row">
                <!-- Notification Banner -->
                <div id="notificationBanner" style="display: none;"></div>

                <!-- Google Drive Sync Banner -->
                <div id="driveBanner" class="notification-banner" style="display: block;">
                    <div class="banner-left">
                        <span>‚òÅÔ∏è</span>
                        <span id="driveStatusText" class="banner-text">Drive: Not connected</span>
                    </div>
                    <div style="display: inline-flex; gap: 8px; align-items: center;">
                        <button id="driveSyncBtn" class="btn-secondary chip-btn"
                                style="display: none;"
                                onclick="syncNow()">Sync</button>
                        <button id="driveActionBtn" class="btn-primary chip-btn"
                                onclick="connectGoogleDrive()">Connect</button>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="view-controls">
                    <div class="results-info" id="resultsInfo">
                        Showing <strong>0</strong> groups
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="switchView('grid')">
                            ‚äû Grid
                        </button>
                        <button class="view-btn" onclick="switchView('table')">
                            ‚ò∞ Table
                        </button>
                    </div>
                </div>

                <!-- Grid View -->
                <div id="gridView" class="groups-grid"></div>

                <!-- Table View -->
                <div id="tableView" class="groups-table" style="display: none;"></div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal" id="groupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">New Group Booking</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div class="modal-tabs">
                    <div class="modal-tab active" data-tab="details" onclick="switchTab('details')">
                        üìã Details
                    </div>
                    <div class="modal-tab" data-tab="documents" onclick="switchTab('documents')">
                        üìÑ Documents <span id="docCountBadge"></span>
                    </div>
                    <div class="modal-tab" data-tab="comments" onclick="switchTab('comments')">
                        üí¨ Comments <span id="commentCountBadge"></span>
                    </div>
                    <div class="modal-tab" data-tab="activity" onclick="switchTab('activity')">
                        üìä Activity
                    </div>
                </div>

                <!-- Details Tab -->
                <div class="tab-content active" id="detailsTab">
                    <form id="groupForm" onsubmit="return false;">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label class="form-label">Group Name *</label>
                                <input type="text" class="form-input" id="groupName" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Team *</label>
                                <input type="text" class="form-input" id="team" placeholder="e.g., SN, SWA" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Current Status</label>
                                <input type="text" class="form-input" id="statusDisplay" readonly style="background: #f7fafc; cursor: not-allowed;">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Airline</label>
                                <input type="text" class="form-input" id="airline">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Route</label>
                                <input type="text" class="form-input" id="route" placeholder="e.g., JFK-LHR">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Departure Date</label>
                                <input type="date" class="form-input" id="departureDate">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Return Date</label>
                                <input type="date" class="form-input" id="returnDate">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Number of Passengers *</label>
                                <input type="number" class="form-input" id="passengers" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Invoice Status</label>
                                <select class="form-select" id="invoiceStatus" onchange="toggleInvoiceNumber()">
                                    <option value="">Not Issued</option>
                                    <option value="issued">Issued</option>
                                    <option value="loaded">Loaded</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>

                            <div class="form-group" id="invoiceNumberGroup" style="display: none;">
                                <label class="form-label">Invoice Number</label>
                                <input type="text" class="form-input" id="invoiceNumber" placeholder="e.g., INV-2024-001">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Net Price per Passenger (EUR)</label>
                                <input type="number" class="form-input" id="netPrice" step="0.01" placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Sale Price per Passenger (EUR)</label>
                                <input type="number" class="form-input" id="salePrice" step="0.01" placeholder="0.00">
                            </div>

                            <div class="form-group full-width">
                                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border: 2px solid #e2e8f0;">
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; text-align: center;">
                                        <div>
                                            <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Total Net</div>
                                            <div style="font-size: 20px; font-weight: 700; color: #2d3748;" id="totalNet">‚Ç¨0.00</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Total Sale</div>
                                            <div style="font-size: 20px; font-weight: 700; color: #2d3748;" id="totalSale">‚Ç¨0.00</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Profit per Pax</div>
                                            <div style="font-size: 20px; font-weight: 700;" id="profitPerPax">‚Ç¨0.00</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Total Profit</div>
                                            <div style="font-size: 20px; font-weight: 700;" id="totalProfit">‚Ç¨0.00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group full-width">
                                <label class="form-label">Reservation Details</label>
                                <textarea class="form-textarea" id="reservation" placeholder="Paste airline reservation details..."></textarea>
                                <button type="button" class="btn-secondary" onclick="parseReservation()" 
                                        style="margin-top: 10px; width: 100%; font-size: 13px;">
                                    ü§ñ Auto-Fill from Reservation
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">1st Deposit Deadline</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="date" class="form-input" id="deposit1Date" style="flex: 1;">
                                    <label style="display: flex; align-items: center; gap: 6px; margin: 0; white-space: nowrap; cursor: pointer;">
                                        <input type="checkbox" id="deposit1Done" onchange="updateGroupStatus()" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px;">Done</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">2nd Deposit Deadline</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="date" class="form-input" id="deposit2Date" style="flex: 1;">
                                    <label style="display: flex; align-items: center; gap: 6px; margin: 0; white-space: nowrap; cursor: pointer;">
                                        <input type="checkbox" id="deposit2Done" onchange="updateGroupStatus()" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px;">Done</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Name Deadline</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="date" class="form-input" id="nameDeadline" style="flex: 1;">
                                    <label style="display: flex; align-items: center; gap: 6px; margin: 0; white-space: nowrap; cursor: pointer;">
                                        <input type="checkbox" id="namesDone" onchange="updateGroupStatus()" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px;">Done</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ticketing Deadline</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="date" class="form-input" id="ticketingDeadline" style="flex: 1;">
                                    <label style="display: flex; align-items: center; gap: 6px; margin: 0; white-space: nowrap; cursor: pointer;">
                                        <input type="checkbox" id="ticketingDone" onchange="updateGroupStatus()" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px;">Done</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group full-width">
                                <label class="form-label">Notes</label>
                                <textarea class="form-textarea" id="notes" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Documents Tab -->
                <div class="tab-content" id="documentsTab">
                    <div class="upload-area" id="uploadArea">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">
                            Drop files here or click to upload
                        </div>
                        <div style="font-size: 13px; color: #718096;">
                            Support for PDFs, images, Word docs, Excel files
                        </div>
                        <input type="file" id="fileInput" multiple style="display: none;">
                    </div>
                    <div class="documents-list" id="documentsList"></div>
                </div>

                <!-- Comments Tab -->
                <div class="tab-content" id="commentsTab">
                    <div class="comments-list" id="commentsList"></div>
                    <div class="comment-form">
                        <textarea class="comment-input" id="commentInput" placeholder="Add a comment..."></textarea>
                        <button class="btn-primary" onclick="addComment()" style="align-self: flex-start;">
                            Post
                        </button>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="tab-content" id="activityTab">
                    <div class="activity-list" id="activityList"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-delete" onclick="deleteGroup()" id="deleteBtn">Delete Group</button>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn-primary" onclick="saveGroup()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">

    <!-- Google Identity Services (GIS) + Google API client -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="window.__gisLoaded=true" onerror="window.__gisLoadFailed=true; console.error('Failed to load Google Identity Services (GIS). Possibly blocked by an extension or network filter.');"></script>
        
    <script>
        // Google Drive Configuration (GIS + REST)
        const GOOGLE_CLIENT_ID = '111732807443-kfuee1p2s8e6b1913mk4i7ut1dm32hlv.apps.googleusercontent.com';
        const GOOGLE_API_KEY = 'AIzaSyBxXkWKG1PhQUi5ZgVCHuDfNi8WEHNJzFQ'; // Public key - restrict by referrer in Google Cloud
        const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file';
        const DRIVE_FILE_NAME = 'group-booking-manager-data.json';

        let driveFileId = null;
        let isGoogleDriveConnected = false;
        let tokenClient = null;
let accessToken = null;

async function waitForGIS(timeoutMs = 8000) {
    const start = Date.now();
    while (Date.now() - start < timeoutMs) {
        if (window.__gisLoadFailed) break;
        if (window.google && google.accounts && google.accounts.oauth2) return true;
        await new Promise(r => setTimeout(r, 100));
    }
    return false;
}
let tokenExpiryMs = 0;

        
        // GIS (Google Identity Services) token state
        let gisTokenClient = null;
        let gisAccessToken = null;
        const DRIVE_CONNECTED_FLAG_KEY = "driveConnected";
// Application State
        let groups = [];
        let currentGroupId = null;
        let currentView = 'grid';
        let currentFilter = 'all';
        let filters = {
            dateRange: '',
            airline: '',
            team: ''
        };
        let searchQuery = '';
        let notificationsEnabled = false;
        let userName = 'You'; // Can be customized

        // Initialize
        function init() {
            loadGroups();
            setupEventListeners();
            checkNotifications();
            initGoogleDriveAsync();
            renderGroups();
            
            // Load sidebar state
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (sidebarCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            
            // Save state
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            
            // Reset table scroll position when sidebar is toggled
            setTimeout(() => {
                const tableView = document.getElementById('tableView');
                if (tableView) {
                    tableView.scrollLeft = 0;
                }
            }, 350); // Wait for animation to complete
        }

        // Initialize Google Drive API (GIS auth + gapi client)
        // Initialize Google Drive (Google Identity Services + REST Drive API)

// Initialize Google Drive after GIS loads (prevents needing to click Connect after refresh)
let autoSyncTimer = null;

function initGoogleDriveAsync() {
    waitForGIS(8000).then((ok) => {
        if (!ok) {
            console.log('GIS not ready for Drive init (may be blocked or slow).');
            return;
        }
        initGoogleDrive();
    });
}

function startAutoSync() {
    if (autoSyncTimer) clearInterval(autoSyncTimer);
    autoSyncTimer = setInterval(() => {
        if (isGoogleDriveConnected && driveFileId) {
            // Pull latest silently (no toast spam)
            loadFromGoogleDrive({ silent: true });
        }
    }, 60000);
}

async function syncNow() {
    try {
        showToast('‚è≥ Syncing from Google Drive...');
        await loadFromGoogleDrive({ silent: false });
        showToast('‚úÖ Synced');
    } catch (e) {
        console.error('Sync error:', e);
        showToast('‚ùå Sync failed: ' + e.message);
    }
}
function initGoogleDrive() {
    try {
        if (!(window.google && google.accounts && google.accounts.oauth2)) {
            console.log('GIS not available (google.accounts.oauth2 missing).');
            return;
        }

        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: SCOPES,
            callback: () => {} // will be set per request
        });

        // Restore previous connection UI state (token must still be acquired)
        const savedDriveFileId = localStorage.getItem('driveFileId');
        const savedConnected = localStorage.getItem('driveConnected') === 'true';
        if (savedConnected && savedDriveFileId) {
            driveFileId = savedDriveFileId;
            isGoogleDriveConnected = true;
            updateDriveUI(true);
            startAutoSync();

            // Try silent token + load
            requestDriveToken(false)
                .then(() => loadFromGoogleDrive())
                .catch(() => {
                    // Silent token may fail; user can click Connect later
                });
        }
    } catch (error) {
        console.log('Google Drive init skipped:', error.message);
    }
}

async function requestDriveToken(interactive) {
    // Ensure GIS script is loaded and token client initialized
    const ok = await waitForGIS(8000);
    if (!ok) {
        const msg = window.__gisLoadFailed
            ? 'Google Identity Services failed to load (blocked by extension/network).'
            : 'Google Identity Services not available (script not loaded yet).';
        throw new Error(msg);
    }
    if (!tokenClient) {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: SCOPES,
            callback: () => {}
        });
    }

    return new Promise((resolve, reject) => {
        tokenClient.callback = (resp) => {
            if (resp.error) return reject(new Error(resp.error));
            accessToken = resp.access_token;
            const expiresIn = (resp.expires_in || 3600) * 1000;
            tokenExpiryMs = Date.now() + expiresIn;
            resolve(resp);
        };
        tokenClient.requestAccessToken({ prompt: interactive ? 'select_account' : '' });
    });
}

function driveUrl(path, params = {}) {
    const u = new URL('https://www.googleapis.com/drive/v3' + path);
    u.searchParams.set('key', GOOGLE_API_KEY);
    Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, v);
    });
    return u.toString();
}

function driveUploadUrl(path, params = {}) {
    const u = new URL('https://www.googleapis.com/upload/drive/v3' + path);
    u.searchParams.set('key', GOOGLE_API_KEY);
    Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, v);
    });
    return u.toString();
}

async function driveFetch(url, options = {}) {
    // Ensure we have a token
    if (!accessToken || Date.now() > tokenExpiryMs - 60_000) {
        await requestDriveToken(false);
    }

    const headers = new Headers(options.headers || {});
    headers.set('Authorization', 'Bearer ' + accessToken);
    // Default JSON content type when body is a plain string/object (upload can override)
    if (options.body && !headers.has('Content-Type') && typeof options.body === 'string') {
        headers.set('Content-Type', 'application/json; charset=utf-8');
    }
    options.headers = headers;

    const res = await fetch(url, options);
    if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`Drive API ${res.status}: ${text || res.statusText}`);
    }
    return res;
}

// Connect to Google Drive
async function connectGoogleDrive() {
    showToast('‚è≥ Connecting to Google Drive...');

    try {
        if (!(window.google && google.accounts && google.accounts.oauth2)) {
            throw new Error('Google Identity Services not available. Check that the GIS script loaded.');
        }

        // Interactive token request (shows consent the first time)
        await requestDriveToken(true);

        isGoogleDriveConnected = true;

        // Find or create the data file
        await findOrCreateDriveFile();

        // Load data from Drive
        await loadFromGoogleDrive();

        // Persist connected flag
        localStorage.setItem('driveConnected', 'true');

        // Update UI
        updateDriveUI(true);
        startAutoSync();

        showToast('‚úÖ Connected to Google Drive successfully!');
    } catch (error) {
        console.error('Google Drive connection error:', error);
        showToast('‚ùå Failed to connect to Google Drive: ' + error.message);
    }
}

// Find or create the data file in Google Drive (AppData)
async function findOrCreateDriveFile() {
    // Search for existing file in appDataFolder
    const q = `name='${DRIVE_FILE_NAME}' and trashed=false`;
    const listUrl = driveUrl('/files', {
        q,
        spaces: 'appDataFolder',
        fields: 'files(id,name)'
    });

    const listRes = await driveFetch(listUrl, { method: 'GET' });
    const listJson = await listRes.json();

    if (listJson.files && listJson.files.length > 0) {
        driveFileId = listJson.files[0].id;
        localStorage.setItem('driveFileId', driveFileId);
        return;
    }

    // Create new file in appDataFolder
    const createUrl = driveUrl('/files', { fields: 'id' });
    const meta = { name: DRIVE_FILE_NAME, parents: ['appDataFolder'] };

    const createRes = await driveFetch(createUrl, {
        method: 'POST',
        body: JSON.stringify(meta)
    });
    const createJson = await createRes.json();
    driveFileId = createJson.id;
    localStorage.setItem('driveFileId', driveFileId);

    // Save current data to the new file (so other devices immediately see it)
    await saveToGoogleDrive();
}

// Update Drive UI
function updateDriveUI(connected) {
    const banner = document.getElementById('driveBanner');
    const statusText = document.getElementById('driveStatusText');
    const actionBtn = document.getElementById('driveActionBtn');
    const syncBtn = document.getElementById('driveSyncBtn');

    if (connected) {
        banner.style.background = '#e6fffa';
        banner.style.borderColor = '#4fd1c5';
        statusText.textContent = '‚úì Connected to Google Drive';
        actionBtn.textContent = 'Disconnect';
        actionBtn.onclick = disconnectGoogleDrive;
        actionBtn.classList.remove('btn-primary');
        actionBtn.classList.add('btn-secondary');

        if (syncBtn) {
            syncBtn.style.display = 'inline-flex';
            syncBtn.disabled = false;
        }
    } else {
        banner.style.background = '#e6f7ff';
        banner.style.borderColor = '#1890ff';
        statusText.textContent = 'Drive: Not connected';
        actionBtn.textContent = 'Connect';
        actionBtn.onclick = connectGoogleDrive;
        actionBtn.classList.remove('btn-secondary');
        actionBtn.classList.add('btn-primary');

        if (syncBtn) {
            syncBtn.style.display = 'none';
            syncBtn.disabled = true;
        }
    }
}

// Disconnect Google Drive
async function disconnectGoogleDrive() {
    if (!confirm('Disconnect from Google Drive? Your data will remain in local storage.')) return;

    localStorage.removeItem('driveFileId');
    localStorage.removeItem('driveConnected');
    driveFileId = null;
    isGoogleDriveConnected = false;
    accessToken = null;
    tokenExpiryMs = 0;

    if (autoSyncTimer) { clearInterval(autoSyncTimer); autoSyncTimer = null; }

    updateDriveUI(false);
    showToast('‚òÅÔ∏è Disconnected from Google Drive');
}

// Load from Google Drive
async function loadFromGoogleDrive(options = {}) {
    if (!isGoogleDriveConnected || !driveFileId) return;

    const silent = options && options.silent === true;

    try {
        const getUrl = driveUrl(`/files/${driveFileId}`, { alt: 'media' });
        const res = await driveFetch(getUrl, { method: 'GET' });

        const text = await res.text();
        if (!text) return;

        const driveData = JSON.parse(text);
        if (driveData && Array.isArray(driveData)) {
            groups = driveData;
            saveGroups(); // save to localStorage too
            renderGroups();
            if (!silent) showToast('‚òÅÔ∏è Loaded latest data from Google Drive');
        }
    } catch (error) {
        // File may be empty initially
        console.error('Error loading from Drive:', error);
        // Don't block the app; keep local data
    }
}

// Save to Google Drive
async function saveToGoogleDrive() {
    if (!isGoogleDriveConnected || !driveFileId) return;

    try {
        const dataToSave = JSON.stringify(groups);

        const uploadUrl = driveUploadUrl(`/files/${driveFileId}`, { uploadType: 'media' });
        await driveFetch(uploadUrl, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json; charset=utf-8' },
            body: dataToSave
        });
    } catch (error) {
        console.error('Error saving to Drive:', error);
        // Background save: no toast
    }
}

        // Load data from localStorage
        function loadGroups() {
            const saved = localStorage.getItem('advancedBookingGroups');
            if (saved) {
                groups = JSON.parse(saved);
            }
        }

        // Save data to localStorage
        function saveGroups() {
            localStorage.setItem('advancedBookingGroups', JSON.stringify(groups));
            
            // Also save to Google Drive if connected
            if (isGoogleDriveConnected) {
                saveToGoogleDrive();
            }
        }

        // Update group status based on completed deadlines
        function updateGroupStatus() {
            const deposit1Done = document.getElementById('deposit1Done').checked;
            const deposit2Done = document.getElementById('deposit2Done').checked;
            const namesDone = document.getElementById('namesDone').checked;
            const ticketingDone = document.getElementById('ticketingDone').checked;
            
            let status = '1st-dep'; // Default status
            
            if (ticketingDone) {
                status = 'complete';
            } else if (namesDone) {
                status = 'tktng';
            } else if (deposit2Done) {
                status = 'names';
            } else if (deposit1Done) {
                status = '2nd-dep';
            }
            
            // Update the display field
            const statusLabels = {
                '1st-dep': 'üí∞ 1st Deposit',
                '2nd-dep': 'üí≥ 2nd Deposit',
                'names': 'üìù Names',
                'tktng': 'üé´ Ticketing',
                'complete': '‚úÖ Complete'
            };
            
            document.getElementById('statusDisplay').value = statusLabels[status];
            
            // Store the actual status value in a hidden way (we'll read it when saving)
            document.getElementById('statusDisplay').setAttribute('data-status', status);
        }

        // Toggle invoice number field visibility
        function toggleInvoiceNumber() {
            const invoiceStatus = document.getElementById('invoiceStatus').value;
            const invoiceNumberGroup = document.getElementById('invoiceNumberGroup');
            
            if (invoiceStatus && invoiceStatus !== '') {
                invoiceNumberGroup.style.display = 'block';
            } else {
                invoiceNumberGroup.style.display = 'none';
            }
        }

        // Calculate and display prices
        function updatePriceCalculations() {
            const passengers = parseInt(document.getElementById('passengers').value) || 0;
            const netPrice = parseFloat(document.getElementById('netPrice').value) || 0;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;

            const totalNet = netPrice * passengers;
            const totalSale = salePrice * passengers;
            const profitPerPax = salePrice - netPrice;
            const totalProfit = profitPerPax * passengers;

            document.getElementById('totalNet').textContent = `‚Ç¨${totalNet.toFixed(2)}`;
            document.getElementById('totalSale').textContent = `‚Ç¨${totalSale.toFixed(2)}`;
            document.getElementById('profitPerPax').textContent = `‚Ç¨${profitPerPax.toFixed(2)}`;
            document.getElementById('profitPerPax').style.color = profitPerPax >= 0 ? '#22543d' : '#742a2a';
            document.getElementById('totalProfit').textContent = `‚Ç¨${totalProfit.toFixed(2)}`;
            document.getElementById('totalProfit').style.color = totalProfit >= 0 ? '#22543d' : '#742a2a';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentFilter = item.dataset.view;
                    renderGroups();
                });
            });

            // Search
            const searchInput = document.getElementById('globalSearch');
            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                document.querySelector('.clear-search').classList.toggle('visible', searchQuery.length > 0);
                renderGroups();
            });

            // Filters
            document.getElementById('dateRangeFilter').addEventListener('change', (e) => {
                filters.dateRange = e.target.value;
                renderGroups();
            });

            document.getElementById('airlineFilter').addEventListener('input', (e) => {
                filters.airline = e.target.value.toLowerCase();
                renderGroups();
            });

            document.getElementById('teamFilter').addEventListener('change', (e) => {
                filters.team = e.target.value;
                renderGroups();
            });

            // Quick filters removed - no longer needed

            // File upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragging');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragging');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragging');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Modal click outside to close
            document.getElementById('groupModal').addEventListener('click', (e) => {
                if (e.target.id === 'groupModal') {
                    closeModal();
                }
            });
        }

        // Filtering and Search Logic
        function filterGroups(groupsList) {
            let filtered = [...groupsList];

            // Status filter
            if (currentFilter === 'due-this-week') {
                // Show groups with deadlines in the next 7 days
                filtered = filtered.filter(g => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const nextWeek = new Date(today);
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    
                    const deadlines = [
                        g.deposit1Date,
                        g.deposit2Date,
                        g.nameDeadline,
                        g.ticketingDeadline
                    ].filter(Boolean);
                    
                    return deadlines.some(date => {
                        const d = new Date(date);
                        d.setHours(0, 0, 0, 0);
                        return d >= today && d <= nextWeek;
                    });
                });
            } else if (currentFilter !== 'all') {
                filtered = filtered.filter(g => g.status === currentFilter);
            }

            // Date range filter
            if (filters.dateRange) {
                const now = new Date();
                filtered = filtered.filter(g => {
                    if (!g.createdAt) return false;
                    const created = new Date(g.createdAt);
                    
                    switch(filters.dateRange) {
                        case 'today':
                            return created.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                            return created >= weekAgo;
                        case 'month':
                            return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
                        case 'quarter':
                            const quarter = Math.floor(now.getMonth() / 3);
                            const createdQuarter = Math.floor(created.getMonth() / 3);
                            return createdQuarter === quarter && created.getFullYear() === now.getFullYear();
                        default:
                            return true;
                    }
                });
            }

            // Airline filter
            if (filters.airline) {
                filtered = filtered.filter(g => 
                    (g.airline || '').toLowerCase().includes(filters.airline)
                );
            }

            // Team filter
            if (filters.team) {
                filtered = filtered.filter(g => 
                    (g.team || '').toLowerCase() === filters.team.toLowerCase()
                );
            }

            // Global search
            if (searchQuery) {
                filtered = filtered.filter(g => {
                    const searchableText = [
                        g.name,
                        g.team,
                        g.airline,
                        g.route,
                        g.reservation,
                        g.notes,
                        g.passengers,
                        g.status
                    ].join(' ').toLowerCase();
                    
                    return searchableText.includes(searchQuery);
                });
            }

            return filtered;
        }

        // Render groups
        function renderGroups() {
            const filtered = filterGroups(groups);
            const sorted = applySorting(filtered);
            
            // Update results info
            document.getElementById('resultsInfo').innerHTML = 
                `Showing <strong>${sorted.length}</strong> of <strong>${groups.length}</strong> groups`;

            // Update team filter dropdown
            updateTeamFilter();

            if (currentView === 'grid') {
                renderGridView(sorted);
            } else {
                renderTableView(sorted);
            }
        }

        // Update team filter dropdown with unique teams
        function updateTeamFilter() {
            const teamFilter = document.getElementById('teamFilter');
            const currentValue = teamFilter.value;
            
            // Get unique teams
            const teams = [...new Set(groups.map(g => g.team).filter(Boolean))].sort();
            
            // Rebuild options
            teamFilter.innerHTML = '<option value="">All Teams</option>';
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamFilter.appendChild(option);
            });
            
            // Restore selection if it still exists
            if (teams.includes(currentValue)) {
                teamFilter.value = currentValue;
            }
        }

        // Render grid view
        function renderGridView(groupsList) {
            const container = document.getElementById('gridView');
            
            if (groupsList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No groups found</h3>
                        <p>Try adjusting your filters or search query</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = groupsList.map(group => {
                const netPrice = parseFloat(group.netPrice) || 0;
                const salePrice = parseFloat(group.salePrice) || 0;
                const passengers = parseInt(group.passengers) || 0;
                const profitPerPax = salePrice - netPrice;
                const totalProfit = profitPerPax * passengers;
                const totalSale = salePrice * passengers;
                const deadlines = getDeadlineBadges(group);
                const docCount = (group.documents || []).length;
                const commentCount = (group.comments || []).length;
                const airlineCode = getAirlineCode(group.airline);

                return `
                    <div class="group-card" onclick="openGroup('${group.id}')">
                        <div class="group-card-header">
                            <div>
                                <div class="group-name">${group.name || 'Untitled Group'}</div>
                                <div class="group-id">#${group.id.substring(0, 8)}</div>
                            </div>
                            <div class="group-status status-${group.status || '1st-dep'}">${getStatusLabel(group.status)}</div>
                        </div>

                        <div class="group-meta">
                            <div class="meta-item">
                                <div class="meta-label">Team</div>
                                <div class="meta-value">${group.team || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Airline</div>
                                <div class="meta-value">${airlineCode || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Route</div>
                                <div class="meta-value">${group.route || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Passengers</div>
                                <div class="meta-value">${passengers || '0'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Next Deadline</div>
                                <div class="meta-value" style="color: ${getNextDeadline(group) ? '#3182ce' : '#a0aec0'};">${getNextDeadline(group) || '-'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Sale/Pax</div>
                                <div class="meta-value">‚Ç¨${salePrice.toFixed(2)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Total Sale</div>
                                <div class="meta-value" style="font-weight: 700;">‚Ç¨${totalSale.toFixed(2)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Invoice</div>
                                <div class="meta-value">${getInvoiceBadge(group.invoiceStatus, group.invoiceNumber)}</div>
                            </div>
                        </div>

                        ${deadlines.length > 0 ? `
                            <div class="group-deadlines">${deadlines.join('')}</div>
                        ` : ''}

                        <div class="group-footer">
                            <div class="document-count">
                                üìÑ ${docCount} documents
                            </div>
                            <div class="comment-count">
                                üí¨ ${commentCount} comments
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render table view
        function renderTableView(groupsList) {
            const container = document.getElementById('tableView');
            
            if (groupsList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No groups found</h3>
                        <p>Try adjusting your filters or search query</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('name')">Group <span class="sort-arrow">‚Üï</span></th>
                            <th onclick="sortTable('airline')">Airline <span class="sort-arrow">‚Üï</span></th>
                            <th onclick="sortTable('route')">Route <span class="sort-arrow">‚Üï</span></th>
                            <th onclick="sortTable('passengers')">Pax <span class="sort-arrow">‚Üï</span></th>
                            <th onclick="sortTable('departureDate')">Departure <span class="sort-arrow">‚Üï</span></th>
                            <th onclick="sortTable('nextDeadline')">Deadline <span class="sort-arrow">‚Üï</span></th>
                            <th onclick="sortTable('status')">Status <span class="sort-arrow">‚Üï</span></th>
                            <th>Invoice</th>
                            <th onclick="sortTable('salePrice')">Price <span class="sort-arrow">‚Üï</span></th>
                            <th onclick="sortTable('totalSale')">Total <span class="sort-arrow">‚Üï</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${groupsList.map(group => {
                            const netPrice = parseFloat(group.netPrice) || 0;
                            const salePrice = parseFloat(group.salePrice) || 0;
                            const passengers = parseInt(group.passengers) || 0;
                            const totalSale = salePrice * passengers;
                            const airlineCode = getAirlineCode(group.airline);
                            const nextDeadline = getNextDeadline(group);
                            
                            return `
                                <tr>
                                    <td onclick="openGroup('${group.id}')"><strong>${group.name || 'Untitled'}</strong></td>
                                    <td onclick="openGroup('${group.id}')">${airlineCode || 'N/A'}</td>
                                    <td onclick="openGroup('${group.id}')">${group.route || 'N/A'}</td>
                                    <td onclick="openGroup('${group.id}')">${passengers || '0'}</td>
                                    <td onclick="openGroup('${group.id}')">${group.departureDate || 'N/A'}</td>
                                    <td onclick="event.stopPropagation(); editDeadlineInline('${group.id}')" style="cursor: pointer; color: ${nextDeadline ? '#3182ce' : '#a0aec0'};" class="deadline-cell" data-group-id="${group.id}">
                                        <span class="deadline-display">${nextDeadline || 'Set deadline'}</span>
                                        <input type="date" class="deadline-input" style="display: none;" value="${nextDeadline || ''}" 
                                               onchange="updateDeadlineInline('${group.id}', this.value)" 
                                               onblur="hideDeadlineInput('${group.id}')">
                                    </td>
                                    <td onclick="openGroup('${group.id}')"><span class="group-status status-${group.status || '1st-dep'}">${getStatusLabel(group.status)}</span></td>
                                    <td onclick="openGroup('${group.id}')">${getInvoiceBadge(group.invoiceStatus, group.invoiceNumber)}</td>
                                    <td onclick="openGroup('${group.id}')">‚Ç¨${salePrice % 1 === 0 ? salePrice.toFixed(0) : salePrice.toFixed(2)}</td>
                                    <td onclick="openGroup('${group.id}')"><strong>‚Ç¨${totalSale % 1 === 0 ? totalSale.toFixed(0) : totalSale.toFixed(2)}</strong></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            // Check if table has horizontal scroll
            setTimeout(() => {
                const tableWrapper = container;
                if (tableWrapper.scrollWidth > tableWrapper.clientWidth) {
                    tableWrapper.classList.add('has-scroll');
                } else {
                    tableWrapper.classList.remove('has-scroll');
                }
            }, 100);
        }

        // Get next deadline for a group (simplified - date only)
        function getNextDeadline(group) {
            if (group.status === 'complete') return '';
            
            // Return just the date of the next uncompleted deadline
            if (!group.deposit1Done && group.deposit1Date) {
                return group.deposit1Date;
            }
            if (!group.deposit2Done && group.deposit2Date) {
                return group.deposit2Date;
            }
            if (!group.namesDone && group.nameDeadline) {
                return group.nameDeadline;
            }
            if (!group.ticketingDone && group.ticketingDeadline) {
                return group.ticketingDeadline;
            }
            
            return '';
        }

        // Sort table by column
        let sortColumn = '';
        let sortAscending = true;
        
        function sortTable(column) {
            // Toggle sort direction if clicking same column
            if (sortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                sortColumn = column;
                sortAscending = true;
            }
            
            renderGroups();
        }
        
        // Apply sorting to groups
        function applySorting(groupsList) {
            if (!sortColumn) return groupsList;
            
            return [...groupsList].sort((a, b) => {
                let aVal, bVal;
                
                switch(sortColumn) {
                    case 'name':
                        aVal = (a.name || '').toLowerCase();
                        bVal = (b.name || '').toLowerCase();
                        break;
                    case 'airline':
                        aVal = (a.airline || '').toLowerCase();
                        bVal = (b.airline || '').toLowerCase();
                        break;
                    case 'route':
                        aVal = (a.route || '').toLowerCase();
                        bVal = (b.route || '').toLowerCase();
                        break;
                    case 'passengers':
                        aVal = parseInt(a.passengers) || 0;
                        bVal = parseInt(b.passengers) || 0;
                        break;
                    case 'departureDate':
                        aVal = a.departureDate ? new Date(a.departureDate) : new Date(0);
                        bVal = b.departureDate ? new Date(b.departureDate) : new Date(0);
                        break;
                    case 'nextDeadline':
                        aVal = getNextDeadlineSort(a);
                        bVal = getNextDeadlineSort(b);
                        break;
                    case 'status':
                        const statusOrder = {'1st-dep': 1, '2nd-dep': 2, 'names': 3, 'tktng': 4, 'complete': 5};
                        aVal = statusOrder[a.status] || 0;
                        bVal = statusOrder[b.status] || 0;
                        break;
                    case 'salePrice':
                        aVal = parseFloat(a.salePrice) || 0;
                        bVal = parseFloat(b.salePrice) || 0;
                        break;
                    case 'totalSale':
                        aVal = (parseFloat(a.salePrice) || 0) * (parseInt(a.passengers) || 0);
                        bVal = (parseFloat(b.salePrice) || 0) * (parseInt(b.passengers) || 0);
                        break;
                    default:
                        return 0;
                }
                
                if (aVal < bVal) return sortAscending ? -1 : 1;
                if (aVal > bVal) return sortAscending ? 1 : -1;
                return 0;
            });
        }
        
        // Get next deadline as sortable date
        function getNextDeadlineSort(group) {
            if (group.status === 'complete') return new Date(8640000000000000); // Max date
            
            if (!group.deposit1Done && group.deposit1Date) return new Date(group.deposit1Date);
            if (!group.deposit2Done && group.deposit2Date) return new Date(group.deposit2Date);
            if (!group.namesDone && group.nameDeadline) return new Date(group.nameDeadline);
            if (!group.ticketingDone && group.ticketingDeadline) return new Date(group.ticketingDeadline);
            
            return new Date(8640000000000000); // Max date for no deadline
        }

        // Inline deadline editing
        function editDeadlineInline(groupId) {
            const cell = document.querySelector(`.deadline-cell[data-group-id="${groupId}"]`);
            if (!cell) return;
            
            const display = cell.querySelector('.deadline-display');
            const input = cell.querySelector('.deadline-input');
            
            display.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
        }

        function hideDeadlineInput(groupId) {
            setTimeout(() => {
                const cell = document.querySelector(`.deadline-cell[data-group-id="${groupId}"]`);
                if (!cell) return;
                
                const display = cell.querySelector('.deadline-display');
                const input = cell.querySelector('.deadline-input');
                
                display.style.display = 'inline';
                input.style.display = 'none';
            }, 200);
        }

        function updateDeadlineInline(groupId, newDate) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            // Determine which deadline to update based on current status
            if (!group.deposit1Done) {
                group.deposit1Date = newDate;
            } else if (!group.deposit2Done) {
                group.deposit2Date = newDate;
            } else if (!group.namesDone) {
                group.nameDeadline = newDate;
            } else if (!group.ticketingDone) {
                group.ticketingDeadline = newDate;
            } else {
                // All deadlines done, set the first one
                group.deposit1Date = newDate;
                group.deposit1Done = false;
            }
            
            saveGroups();
            renderGroups();
            showToast('üìÖ Deadline updated!');
        }

        // Get status display label
        function getStatusLabel(status) {
            const labels = {
                '1st-dep': '1st Dep',
                '2nd-dep': '2nd Dep',
                'names': 'Names',
                'tktng': 'Tktng',
                'complete': 'Complete'
            };
            return labels[status] || '1st Dep';
        }

        // Get invoice status badge
        function getInvoiceBadge(status, invoiceNumber) {
            if (!status) {
                return '<span class="invoice-badge invoice-not-issued">Not Issued</span>';
            }
            
            const statusText = {
                'issued': 'Issued',
                'loaded': 'Loaded',
                'paid': 'Paid'
            };
            
            const statusClass = {
                'issued': 'invoice-issued',
                'loaded': 'invoice-loaded',
                'paid': 'invoice-paid'
            };
            
            const text = statusText[status] || 'Not Issued';
            const cssClass = statusClass[status] || 'invoice-not-issued';
            const number = invoiceNumber ? ` #${invoiceNumber}` : '';
            
            return `<span class="invoice-badge ${cssClass}">${text}${number}</span>`;
        }

        // Get airline code from airline name
        function getAirlineCode(airlineName) {
            if (!airlineName) return '';
            
            // If it's already a 2-letter code, return it
            if (/^[A-Z0-9]{2}$/.test(airlineName.trim())) {
                return airlineName.trim();
            }
            
            // Map of full airline names to codes
            const airlineMap = {
                'Austrian Airlines': 'OS',
                'Lufthansa': 'LH',
                'British Airways': 'BA',
                'Air France': 'AF',
                'KLM': 'KL',
                'Swiss': 'LX',
                'Swiss International Air Lines': 'LX',
                'ITA Airways': 'AZ',
                'Alitalia': 'AZ',
                'TAP Portugal': 'TP',
                'TAP Air Portugal': 'TP',
                'Iberia': 'IB',
                'Brussels Airlines': 'SN',
                'LOT Polish Airlines': 'LO',
                'Turkish Airlines': 'TK',
                'Aegean Airlines': 'A3',
                'Air Baltic': 'BT',
                'Finnair': 'AY',
                'SAS': 'SK',
                'Scandinavian Airlines': 'SK',
                'Air Serbia': 'JU',
                'Tarom': 'RO',
                'Croatia Airlines': 'OU',
                'Czech Airlines': 'OK',
                'Aeroflot': 'SU',
                'Ukraine International': 'PS',
                'Wizz Air': 'W6',
                'Ryanair': 'FR',
                'easyJet': 'U2',
                'Pegasus Airlines': 'PC',
                'Pegasus': 'PC',
                'Vueling': 'VY',
                'Eurowings': 'EW',
                'Aer Lingus': 'EI',
                'Norwegian': 'DY',
                'Flyone': '5F',
                'SkyUp Airlines': 'U5',
                'SkyUp': 'U5',
                'HiSky': 'H4'
            };
            
            // Try exact match
            if (airlineMap[airlineName]) {
                return airlineMap[airlineName];
            }
            
            // Try partial match
            for (const [fullName, code] of Object.entries(airlineMap)) {
                if (airlineName.toLowerCase().includes(fullName.toLowerCase()) || 
                    fullName.toLowerCase().includes(airlineName.toLowerCase())) {
                    return code;
                }
            }
            
            // If no match, return first two characters uppercased
            return airlineName.substring(0, 2).toUpperCase();
        }

        // Get deadline badges
        function getDeadlineBadges(group) {
            const badges = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const checkDeadline = (date, label) => {
                if (!date) return;
                const deadline = new Date(date);
                deadline.setHours(0, 0, 0, 0);
                const diff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));

                if (diff < 0) {
                    badges.push(`<span class="deadline-badge deadline-urgent">${label} OVERDUE</span>`);
                } else if (diff <= 3) {
                    badges.push(`<span class="deadline-badge deadline-urgent">${label} ${diff}d</span>`);
                } else if (diff <= 7) {
                    badges.push(`<span class="deadline-badge deadline-warning">${label} ${diff}d</span>`);
                }
            };

            checkDeadline(group.deposit1Date, 'Deposit 1');
            checkDeadline(group.deposit2Date, 'Deposit 2');
            checkDeadline(group.nameDeadline, 'Names');
            checkDeadline(group.ticketingDeadline, 'Ticketing');

            return badges;
        }

        // Check if group has urgent deadlines
        function hasUrgentDeadlines(group) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const deadlines = [
                group.deposit1Date,
                group.deposit2Date,
                group.nameDeadline,
                group.ticketingDeadline
            ];

            return deadlines.some(date => {
                if (!date) return false;
                const deadline = new Date(date);
                deadline.setHours(0, 0, 0, 0);
                const diff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                return diff <= 3;
            });
        }

        // Switch view
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (view === 'grid') {
                document.getElementById('gridView').style.display = 'grid';
                document.getElementById('tableView').style.display = 'none';
            } else {
                document.getElementById('gridView').style.display = 'none';
                document.getElementById('tableView').style.display = 'block';
            }

            renderGroups();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('globalSearch').value = '';
            searchQuery = '';
            document.querySelector('.clear-search').classList.remove('visible');
            renderGroups();
        }

        // Clear all filters
        function clearAllFilters() {
            filters = {
                dateRange: '',
                airline: '',
                team: ''
            };
            
            document.getElementById('dateRangeFilter').value = '';
            document.getElementById('airlineFilter').value = '';
            document.getElementById('teamFilter').value = '';
            
            renderGroups();
        }

        // Create new group
        function createNewGroup() {
            currentGroupId = null;
            document.getElementById('modalTitle').textContent = 'New Group Booking';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('groupForm').reset();
            
            // Set default status
            document.getElementById('statusDisplay').value = 'üí∞ 1st Deposit';
            document.getElementById('statusDisplay').setAttribute('data-status', '1st-dep');
            
            // Uncheck all deadline boxes
            document.getElementById('deposit1Done').checked = false;
            document.getElementById('deposit2Done').checked = false;
            document.getElementById('namesDone').checked = false;
            document.getElementById('ticketingDone').checked = false;
            
            // Reset invoice status
            document.getElementById('invoiceStatus').value = '';
            toggleInvoiceNumber();
            
            // Reset price calculations
            updatePriceCalculations();

            // Add event listeners for live price updates
            ['passengers', 'netPrice', 'salePrice'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.removeEventListener('input', updatePriceCalculations);
                field.addEventListener('input', updatePriceCalculations);
            });
            
            // Clear all tabs
            document.getElementById('documentsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No documents yet</p></div>';
            document.getElementById('commentsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No comments yet</p></div>';
            document.getElementById('activityList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No activity yet</p></div>';
            
            switchTab('details');
            document.getElementById('groupModal').classList.add('active');
        }

        // Open existing group
        function openGroup(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;

            currentGroupId = id;
            document.getElementById('modalTitle').textContent = group.name || 'Group Details';
            document.getElementById('deleteBtn').style.display = 'block';

            // Populate form
            document.getElementById('groupName').value = group.name || '';
            document.getElementById('team').value = group.team || '';
            document.getElementById('airline').value = group.airline || '';
            document.getElementById('route').value = group.route || '';
            document.getElementById('departureDate').value = group.departureDate || '';
            document.getElementById('returnDate').value = group.returnDate || '';
            document.getElementById('passengers').value = group.passengers || '';
            document.getElementById('netPrice').value = group.netPrice || '';
            document.getElementById('salePrice').value = group.salePrice || '';
            document.getElementById('deposit1Done').checked = group.deposit1Done || false;
            document.getElementById('deposit2Done').checked = group.deposit2Done || false;
            document.getElementById('namesDone').checked = group.namesDone || false;
            document.getElementById('ticketingDone').checked = group.ticketingDone || false;
            document.getElementById('invoiceStatus').value = group.invoiceStatus || '';
            document.getElementById('invoiceNumber').value = group.invoiceNumber || '';
            document.getElementById('reservation').value = group.reservation || '';
            document.getElementById('deposit1Date').value = group.deposit1Date || '';
            document.getElementById('deposit2Date').value = group.deposit2Date || '';
            document.getElementById('nameDeadline').value = group.nameDeadline || '';
            document.getElementById('ticketingDeadline').value = group.ticketingDeadline || '';
            document.getElementById('notes').value = group.notes || '';

            // Update status display
            updateGroupStatus();

            // Toggle invoice number field visibility
            toggleInvoiceNumber();

            // Update price calculations
            updatePriceCalculations();

            // Add event listeners for live price updates
            ['passengers', 'netPrice', 'salePrice'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.removeEventListener('input', updatePriceCalculations);
                field.addEventListener('input', updatePriceCalculations);
            });

            // Render documents
            renderDocuments(group);
            
            // Render comments
            renderComments(group);
            
            // Render activity
            renderActivity(group);

            switchTab('details');
            document.getElementById('groupModal').classList.add('active');
        }

        // Parse reservation details
        function parseReservation() {
            const reservationText = document.getElementById('reservation').value;
            if (!reservationText) return;

            // Detect reservation type
            const isWizzAir = reservationText.includes('Flight Number: W6') || /W6\s*\d{4}/.test(reservationText);
            const isPegasus = reservationText.includes('Group Request') || /PC\d{3}/.test(reservationText);
            const isFlyone = /5F\s*\d{4}/.test(reservationText) || reservationText.includes('Booking code:');
            const isSkyUp = /U5\s*\d{3}/.test(reservationText) || (reservationText.includes('PNR:') && reservationText.includes('U5'));
            const isHiSky = /H4\s*\d{4}/.test(reservationText);
            const isLOT = /LO\s*\d{3}/.test(reservationText) && (reservationText.includes('RMOWAW') || reservationText.includes('WAWKSC'));
            const isTurkish = /TK\s*\d{3,4}/.test(reservationText) && (reservationText.includes('RMOIST') || reservationText.includes('ISTRMO'));

            // === FLYONE FORMAT ===
            if (isFlyone) {
                document.getElementById('airline').value = 'Flyone';
                
                // Extract passenger count
                const paxMatch = reservationText.match(/Number of passengers:\s*(\d+)/i);
                if (paxMatch) {
                    document.getElementById('passengers').value = paxMatch[1];
                }
                
                // Extract route and date from line like "5F 5711 24MAR RMODUB 2020 2220"
                const flightMatch = reservationText.match(/5F\s*\d+\s+(\d{2}[A-Z]{3})\s+([A-Z]{3})([A-Z]{3})/i);
                if (flightMatch) {
                    document.getElementById('route').value = `${flightMatch[2]}-${flightMatch[3]}`;
                    
                    const dateStr = flightMatch[1];
                    const parsedDate = parseAirlineDate(dateStr);
                    if (parsedDate) {
                        document.getElementById('departureDate').value = parsedDate;
                    }
                }
                
                showToast('‚úÖ Flyone reservation parsed!');
                return;
            }

            // === SKYUP FORMAT ===
            if (isSkyUp) {
                document.getElementById('airline').value = 'SkyUp Airlines';
                
                // Extract passenger count from "75+0+0" format
                const paxMatch = reservationText.match(/(\d+)\+\d+\+\d+\s*\(\d+\+\d+\+\d+\)/);
                if (paxMatch) {
                    document.getElementById('passengers').value = paxMatch[1];
                }
                
                // Extract routes - try both formats
                // Format 1: RMO-LCA / LCA-RMO
                let routeMatch = reservationText.match(/([A-Z]{3})-([A-Z]{3})\s*\n?\s*([A-Z]{3})-([A-Z]{3})/);
                if (routeMatch) {
                    if (routeMatch[1] === routeMatch[4]) {
                        document.getElementById('route').value = `${routeMatch[1]}-${routeMatch[2]}`;
                    } else {
                        document.getElementById('route').value = `${routeMatch[1]}-${routeMatch[2]}-${routeMatch[4]}`;
                    }
                }
                
                // Format 2: U5 533RMO - LCA
                if (!routeMatch) {
                    const flights = Array.from(reservationText.matchAll(/U5\s*\d+\s*([A-Z]{3})\s*-\s*([A-Z]{3})/gi));
                    if (flights.length > 0) {
                        const allAirports = [flights[0][1]];
                        flights.forEach(flight => {
                            if (allAirports[allAirports.length - 1] !== flight[2]) {
                                allAirports.push(flight[2]);
                            }
                        });
                        document.getElementById('route').value = allAirports.join('-');
                    }
                }
                
                // Extract dates - Format: 09:00 29.03 or 29.03.2026
                const dateMatches = Array.from(reservationText.matchAll(/(\d{2})\.(\d{2})(?:\.(\d{4}))?/g));
                if (dateMatches.length > 0) {
                    const firstDate = dateMatches[0];
                    const year = firstDate[3] || new Date().getFullYear();
                    document.getElementById('departureDate').value = `${year}-${firstDate[2]}-${firstDate[1]}`;
                    
                    if (dateMatches.length > 1) {
                        const lastDate = dateMatches[dateMatches.length - 1];
                        const retYear = lastDate[3] || year;
                        document.getElementById('returnDate').value = `${retYear}-${lastDate[2]}-${lastDate[1]}`;
                    }
                }
                
                showToast('‚úÖ SkyUp reservation parsed!');
                return;
            }

            // === HISKY FORMAT ===
            if (isHiSky) {
                document.getElementById('airline').value = 'HiSky';
                
                // Extract passenger count from HK29
                const paxMatch = reservationText.match(/HK(\d+)/);
                if (paxMatch) {
                    document.getElementById('passengers').value = paxMatch[1];
                }
                
                // Extract route from line like "H4 0481 O SU 30NOV25RMO OTP HK29"
                const routeMatch = reservationText.match(/H4\s*\d+\s+[A-Z]\s+[A-Z]{2}\s+\d{2}[A-Z]{3}\d{2}([A-Z]{3})\s*([A-Z]{3})/i);
                if (routeMatch) {
                    document.getElementById('route').value = `${routeMatch[1]}-${routeMatch[2]}`;
                }
                
                // Extract date from "30NOV25"
                const dateMatch = reservationText.match(/\d+\s+([A-Z]{2})\s+(\d{2}[A-Z]{3}\d{2})/i);
                if (dateMatch) {
                    const parsedDate = parseAirlineDate(dateMatch[2]);
                    if (parsedDate) {
                        document.getElementById('departureDate').value = parsedDate;
                    }
                }
                
                showToast('‚úÖ HiSky reservation parsed!');
                return;
            }

            // === LOT FORMAT ===
            if (isLOT) {
                document.getElementById('airline').value = 'LOT Polish Airlines';
                
                // Extract passenger count
                const paxMatch = reservationText.match(/HK(\d+)/);
                if (paxMatch) {
                    document.getElementById('passengers').value = paxMatch[1];
                }
                
                // Extract route segments
                const segments = Array.from(reservationText.matchAll(/LO\s*\d+\s+[A-Z]\s+\d{2}[A-Z]{3}\s+\d+\s+([A-Z]{3})([A-Z]{3})/g));
                if (segments.length > 0) {
                    const allAirports = [segments[0][1]];
                    segments.forEach(seg => {
                        if (allAirports[allAirports.length - 1] !== seg[2]) {
                            allAirports.push(seg[2]);
                        }
                    });
                    document.getElementById('route').value = allAirports.join('-');
                }
                
                // Extract departure date
                const dateMatch = reservationText.match(/LO\s*\d+\s+[A-Z]\s+(\d{2}[A-Z]{3})/);
                if (dateMatch) {
                    const parsedDate = parseAirlineDate(dateMatch[1]);
                    if (parsedDate) {
                        document.getElementById('departureDate').value = parsedDate;
                    }
                }
                
                // Extract name deadline
                const nameDeadline = reservationText.match(/NAME ON OR BEFORE\s+(\d{2}[A-Z]{3})/i);
                if (nameDeadline) {
                    const parsedDate = parseAirlineDate(nameDeadline[1]);
                    if (parsedDate) {
                        document.getElementById('nameDeadline').value = parsedDate;
                    }
                }
                
                // Extract ticketing deadline
                const tktDeadline = reservationText.match(/TICKET ON OR BEFORE\s+(\d{2}[A-Z]{3})/i);
                if (tktDeadline) {
                    const parsedDate = parseAirlineDate(tktDeadline[1]);
                    if (parsedDate) {
                        document.getElementById('ticketingDeadline').value = parsedDate;
                    }
                }
                
                showToast('‚úÖ LOT reservation parsed!');
                return;
            }

            // === TURKISH AIRLINES FORMAT ===
            if (isTurkish) {
                document.getElementById('airline').value = 'Turkish Airlines';
                
                // Extract passenger count from KK27
                const paxMatch = reservationText.match(/KK(\d+)/);
                if (paxMatch) {
                    document.getElementById('passengers').value = paxMatch[1];
                }
                
                // Extract route segments
                const segments = Array.from(reservationText.matchAll(/TK\s*\d+\s+[A-Z]\s+[A-Z]{2}\s+\d{2}[A-Z]{3}\s+([A-Z]{3})([A-Z]{3})/g));
                if (segments.length > 0) {
                    const allAirports = [segments[0][1]];
                    segments.forEach(seg => {
                        if (allAirports[allAirports.length - 1] !== seg[2]) {
                            allAirports.push(seg[2]);
                        }
                    });
                    document.getElementById('route').value = allAirports.join('-');
                }
                
                // Extract departure date
                const dateMatch = reservationText.match(/TK\s*\d+\s+[A-Z]\s+[A-Z]{2}\s+(\d{2}[A-Z]{3})/);
                if (dateMatch) {
                    const parsedDate = parseAirlineDate(dateMatch[1]);
                    if (parsedDate) {
                        document.getElementById('departureDate').value = parsedDate;
                    }
                }
                
                // Extract name deadline from "QWR/1600/04APR NAMES"
                const nameDeadline = reservationText.match(/(\d{2}[A-Z]{3})\s+NAMES/i);
                if (nameDeadline) {
                    const parsedDate = parseAirlineDate(nameDeadline[1]);
                    if (parsedDate) {
                        document.getElementById('nameDeadline').value = parsedDate;
                    }
                }
                
                // Extract ticketing deadline from "QWR/1600/09APR TICKETING"
                const tktDeadline = reservationText.match(/(\d{2}[A-Z]{3})\s+TICKETING/i);
                if (tktDeadline) {
                    const parsedDate = parseAirlineDate(tktDeadline[1]);
                    if (parsedDate) {
                        document.getElementById('ticketingDeadline').value = parsedDate;
                    }
                }
                
                showToast('‚úÖ Turkish Airlines reservation parsed!');
                return;
            }

            // === WIZZ AIR FORMAT ===
            if (isWizzAir) {
                document.getElementById('airline').value = 'Wizz Air';
                
                // Extract routes from "Departs from" and "Arrives to" or direct airport codes
                const routePattern = /(?:Departs from:|From:).*?([A-Z]{3}).*?(?:Arrives to:|To:).*?([A-Z]{3})/gi;
                const routes = Array.from(reservationText.matchAll(routePattern));
                
                if (routes.length > 0) {
                    const allAirports = [routes[0][1]]; // Origin
                    routes.forEach(route => {
                        if (allAirports[allAirports.length - 1] !== route[2]) {
                            allAirports.push(route[2]);
                        }
                    });
                    document.getElementById('route').value = allAirports.join('-');
                }
                
                // Extract dates from format: 08/02/2026 15:40
                const datePattern = /(\d{2}\/\d{2}\/\d{4})/g;
                const dates = Array.from(reservationText.matchAll(datePattern));
                
                if (dates.length > 0) {
                    // First date is departure
                    const depParts = dates[0][1].split('/');
                    document.getElementById('departureDate').value = `${depParts[2]}-${depParts[1]}-${depParts[0]}`;
                    
                    // Last date is return (if exists)
                    if (dates.length > 2) {
                        const retParts = dates[dates.length - 2][1].split('/');
                        document.getElementById('returnDate').value = `${retParts[2]}-${retParts[1]}-${retParts[0]}`;
                    }
                }
                
                showToast('‚úÖ Wizz Air reservation parsed!');
                return;
            }

            // === PEGASUS FORMAT ===
            if (isPegasus) {
                document.getElementById('airline').value = 'Pegasus Airlines';
                
                // Extract passenger count from "14 **Group Pax Count"
                const paxMatch = reservationText.match(/(\d+)\s*\*\*\s*Group Pax Count/i);
                if (paxMatch) {
                    document.getElementById('passengers').value = paxMatch[1];
                }
                
                // Extract routes from lines like "01/02/2026 PC431 Kishinev - Antalya"
                const flightPattern = /\d{2}\/\d{2}\/\d{4}\s+PC\d{3}\s+([A-Za-z]+)\s*-\s*([A-Za-z]+)/gi;
                const flights = Array.from(reservationText.matchAll(flightPattern));
                
                if (flights.length > 0) {
                    // Convert city names to airport codes (or keep as is)
                    const cityToCode = {
                        'kishinev': 'KIV',
                        'chisinau': 'KIV',
                        'antalya': 'AYT',
                        'istanbul': 'IST',
                        'ankara': 'ESB',
                        'izmir': 'ADB'
                    };
                    
                    const origin = flights[0][1].toLowerCase();
                    const destination = flights[flights.length - 1][2].toLowerCase();
                    
                    const originCode = cityToCode[origin] || flights[0][1].substring(0, 3).toUpperCase();
                    const destCode = cityToCode[destination] || flights[flights.length - 1][2].substring(0, 3).toUpperCase();
                    
                    if (flights.length === 1) {
                        document.getElementById('route').value = `${originCode}-${destCode}`;
                    } else {
                        const allCities = [originCode];
                        flights.forEach(flight => {
                            const dest = flight[2].toLowerCase();
                            const code = cityToCode[dest] || flight[2].substring(0, 3).toUpperCase();
                            if (allCities[allCities.length - 1] !== code) {
                                allCities.push(code);
                            }
                        });
                        document.getElementById('route').value = allCities.join('-');
                    }
                }
                
                // Extract dates
                const datePattern = /(\d{2}\/\d{2}\/\d{4})\s+PC\d{3}/g;
                const dates = Array.from(reservationText.matchAll(datePattern));
                
                if (dates.length > 0) {
                    // First date is departure
                    const depParts = dates[0][1].split('/');
                    document.getElementById('departureDate').value = `${depParts[2]}-${depParts[1]}-${depParts[0]}`;
                    
                    // Last date is return
                    if (dates.length > 1) {
                        const retParts = dates[dates.length - 1][1].split('/');
                        document.getElementById('returnDate').value = `${retParts[2]}-${retParts[1]}-${retParts[0]}`;
                    }
                }
                
                showToast('‚úÖ Pegasus reservation parsed!');
                return;
            }

            // === STANDARD GDS FORMAT (Austrian Airlines, etc.) ===
            // Extract airline from flight numbers (e.g., "OS 796" or "OPERATED BY AIR BALTIC" or "PC123" or "W6 1234")
            // Try multiple patterns for different airline formats
            
            // Pattern 1: Standard format with space (OS 796, W6 1234)
            let airlineMatch = reservationText.match(/\b([A-Z]{2})\s+(\d{3,4})\s+[A-Z]\s+\d{2}[A-Z]{3}/);
            
            // Pattern 2: No space format (PC123, W61234)
            if (!airlineMatch) {
                airlineMatch = reservationText.match(/\b([A-Z]{2})(\d{3,4})\s+[A-Z]\s+\d{2}[A-Z]{3}/);
            }
            
            // Pattern 3: "OPERATED BY" line
            if (!airlineMatch) {
                const operatedMatch = reservationText.match(/OPERATED BY\s+([A-Z\s]+)/i);
                if (operatedMatch) {
                    airlineMatch = [null, operatedMatch[1].trim()];
                }
            }
            
            if (airlineMatch) {
                const airlineCode = airlineMatch[1];
                const airlineMap = {
                    'OS': 'Austrian Airlines',
                    'LH': 'Lufthansa',
                    'BA': 'British Airways',
                    'AF': 'Air France',
                    'KL': 'KLM',
                    'LX': 'Swiss',
                    'AZ': 'ITA Airways',
                    'TP': 'TAP Portugal',
                    'IB': 'Iberia',
                    'SN': 'Brussels Airlines',
                    'LO': 'LOT Polish Airlines',
                    'TK': 'Turkish Airlines',
                    'A3': 'Aegean Airlines',
                    'BT': 'Air Baltic',
                    'AY': 'Finnair',
                    'SK': 'SAS',
                    'JU': 'Air Serbia',
                    'RO': 'Tarom',
                    'OU': 'Croatia Airlines',
                    'OK': 'Czech Airlines',
                    'SU': 'Aeroflot',
                    'PS': 'Ukraine International',
                    'W6': 'Wizz Air',
                    'FR': 'Ryanair',
                    'U2': 'easyJet',
                    'PC': 'Pegasus Airlines',
                    'VY': 'Vueling',
                    'EW': 'Eurowings',
                    'EI': 'Aer Lingus',
                    'DY': 'Norwegian',
                    '5F': 'Flyone',
                    'U5': 'SkyUp Airlines',
                    'H4': 'HiSky'
                };
                
                if (airlineMap[airlineCode]) {
                    document.getElementById('airline').value = airlineMap[airlineCode];
                } else if (typeof airlineMatch[1] === 'string' && airlineMatch[1].length > 2) {
                    // It's a full name from "OPERATED BY"
                    document.getElementById('airline').value = airlineMatch[1];
                } else {
                    document.getElementById('airline').value = airlineCode;
                }
            }

            // Extract route from flight segments
            // Try multiple patterns for different formats
            
            // Pattern 1: Standard with HK (LCAVIE HK25)
            let routeMatches = Array.from(reservationText.matchAll(/\b([A-Z]{3})([A-Z]{3})\s+HK/g));
            
            // Pattern 2: Without HK but with flight number pattern
            if (routeMatches.length === 0) {
                routeMatches = Array.from(reservationText.matchAll(/\b[A-Z]{2}\d{3,4}\s+[A-Z]\s+\d{2}[A-Z]{3}\s+\d+\s+([A-Z]{3})([A-Z]{3})/g));
            }
            
            // Pattern 3: Look for airport codes before times (1710 1930 pattern)
            if (routeMatches.length === 0) {
                routeMatches = Array.from(reservationText.matchAll(/\b([A-Z]{3})([A-Z]{3})\s+\d{4}\s+\d{4}/g));
            }
            
            if (routeMatches.length > 0) {
                // Build complete route with all connections
                const allAirports = [routeMatches[0][1]]; // Start with origin
                
                routeMatches.forEach((match, index) => {
                    const destination = match[2];
                    // Only add if it's not a duplicate of the last airport
                    if (allAirports[allAirports.length - 1] !== destination) {
                        allAirports.push(destination);
                    }
                });
                
                document.getElementById('route').value = allAirports.join('-');
            }

            // Extract departure date - try multiple formats
            // Format 1: 31MAR 2 (standard)
            let depDateMatch = reservationText.match(/\b(\d{2}[A-Z]{3})\s+\d+\s+[A-Z]{3}[A-Z]{3}/);
            
            // Format 2: Just date at start of line with flight info
            if (!depDateMatch) {
                depDateMatch = reservationText.match(/\b(\d{2}[A-Z]{3}\d{2})\b/);
            }
            
            if (depDateMatch) {
                const dateStr = depDateMatch[1];
                const parsedDate = parseAirlineDate(dateStr);
                if (parsedDate) {
                    document.getElementById('departureDate').value = parsedDate;
                }
            }

            // Extract return date from last segment
            const allDateMatches = Array.from(reservationText.matchAll(/\b(\d{2}[A-Z]{3})\s+\d+\s+[A-Z]{3}[A-Z]{3}/g));
            if (allDateMatches.length > 1) {
                const returnDateStr = allDateMatches[allDateMatches.length - 1][1];
                const parsedReturn = parseAirlineDate(returnDateStr);
                if (parsedReturn) {
                    document.getElementById('returnDate').value = parsedReturn;
                }
            }

            // Extract name deadline - multiple patterns
            let nameDeadlineMatch = reservationText.match(/NONAMES WILL BE XXD IF NAMES NOT AVAIL BY\s+(\d{4})\/(\d{2}[A-Z]{3}\d{2})/i);
            if (!nameDeadlineMatch) {
                nameDeadlineMatch = reservationText.match(/NAME.*?DEADLINE.*?(\d{2}[A-Z]{3}\d{2})/i);
            }
            if (!nameDeadlineMatch) {
                nameDeadlineMatch = reservationText.match(/SSR\s+OTHS.*?NAMES.*?(\d{2}[A-Z]{3}\d{2})/i);
            }
            
            if (nameDeadlineMatch) {
                const dateStr = nameDeadlineMatch[nameDeadlineMatch.length - 1];
                const parsedDate = parseAirlineDate(dateStr);
                if (parsedDate) {
                    document.getElementById('nameDeadline').value = parsedDate;
                }
            }

            // Extract ticketing deadline - multiple patterns
            let ticketingMatch = reservationText.match(/PLS ISSUE TIX UNTIL\s+(\d{4})\/(\d{2}[A-Z]{3}\d{2})/i);
            if (!ticketingMatch) {
                ticketingMatch = reservationText.match(/TICKET.*?DEADLINE.*?(\d{2}[A-Z]{3}\d{2})/i);
            }
            if (!ticketingMatch) {
                ticketingMatch = reservationText.match(/TKT.*?(\d{2}[A-Z]{3}\d{2})/i);
            }
            if (!ticketingMatch) {
                ticketingMatch = reservationText.match(/SSR\s+OTHS.*?TIX.*?(\d{2}[A-Z]{3}\d{2})/i);
            }
            
            if (ticketingMatch) {
                const dateStr = ticketingMatch[ticketingMatch.length - 1];
                const parsedDate = parseAirlineDate(dateStr);
                if (parsedDate) {
                    document.getElementById('ticketingDeadline').value = parsedDate;
                }
            }

            // Extract passenger count - multiple patterns
            // Pattern 1: HK25
            let paxMatch = reservationText.match(/HK(\d{1,3})\b/);
            // Pattern 2: Just number followed by pax/PAX
            if (!paxMatch) {
                paxMatch = reservationText.match(/(\d{1,3})\s*(?:PAX|pax)/i);
            }
            // Pattern 3: Number in group context
            if (!paxMatch) {
                paxMatch = reservationText.match(/GROUP.*?(\d{1,3})/i);
            }
            
            if (paxMatch && !document.getElementById('passengers').value) {
                document.getElementById('passengers').value = paxMatch[1];
            }

            // Show notification
            showToast('‚úÖ Reservation parsed! Please review the extracted information.');
        }

        // Parse airline date format (e.g., "31MAR" or "01MAR26") to YYYY-MM-DD
        function parseAirlineDate(dateStr) {
            const months = {
                'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04',
                'MAY': '05', 'JUN': '06', 'JUL': '07', 'AUG': '08',
                'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
            };

            // Match formats like "31MAR" or "31MAR26"
            const match = dateStr.match(/(\d{2})([A-Z]{3})(\d{2})?/);
            if (!match) return null;

            const day = match[1];
            const month = months[match[2]];
            let year = match[3];

            // If year is provided (e.g., "26"), assume 20XX
            if (year) {
                year = '20' + year;
            } else {
                // If no year, assume current year or next year based on current month
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth() + 1;
                const targetMonth = parseInt(month);
                
                // If the month has passed this year, assume next year
                year = targetMonth < currentMonth ? (currentYear + 1).toString() : currentYear.toString();
            }

            if (!month) return null;

            return `${year}-${month}-${day}`;
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: #48bb78;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Save group
        function saveGroup() {
            const statusDisplay = document.getElementById('statusDisplay');
            const formData = {
                name: document.getElementById('groupName').value,
                team: document.getElementById('team').value,
                airline: document.getElementById('airline').value,
                route: document.getElementById('route').value,
                departureDate: document.getElementById('departureDate').value,
                returnDate: document.getElementById('returnDate').value,
                passengers: document.getElementById('passengers').value,
                netPrice: document.getElementById('netPrice').value,
                salePrice: document.getElementById('salePrice').value,
                status: statusDisplay.getAttribute('data-status') || '1st-dep',
                deposit1Done: document.getElementById('deposit1Done').checked,
                deposit2Done: document.getElementById('deposit2Done').checked,
                namesDone: document.getElementById('namesDone').checked,
                ticketingDone: document.getElementById('ticketingDone').checked,
                invoiceStatus: document.getElementById('invoiceStatus').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                reservation: document.getElementById('reservation').value,
                deposit1Date: document.getElementById('deposit1Date').value,
                deposit2Date: document.getElementById('deposit2Date').value,
                nameDeadline: document.getElementById('nameDeadline').value,
                ticketingDeadline: document.getElementById('ticketingDeadline').value,
                notes: document.getElementById('notes').value
            };

            if (!formData.name || !formData.passengers || !formData.team) {
                alert('Please fill in required fields (Group Name, Team, and Passengers)');
                return;
            }

            if (currentGroupId) {
                // Update existing
                const group = groups.find(g => g.id === currentGroupId);
                Object.assign(group, formData);
                group.updatedAt = new Date().toISOString();
                
                // Add activity log
                addActivity(group, 'edit', `Updated group details`);
            } else {
                // Create new
                const newGroup = {
                    id: Date.now().toString(),
                    ...formData,
                    documents: [],
                    comments: [],
                    activity: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                groups.unshift(newGroup);
                addActivity(newGroup, 'edit', `Created group booking`);
            }

            saveGroups();
            renderGroups();
            closeModal();
        }

        // Delete group
        function deleteGroup() {
            if (!confirm('Are you sure you want to delete this group? This cannot be undone.')) return;
            
            groups = groups.filter(g => g.id !== currentGroupId);
            saveGroups();
            renderGroups();
            closeModal();
        }

        // Close modal
        function closeModal() {
            document.getElementById('groupModal').classList.remove('active');
            currentGroupId = null;
        }

        // Switch tab
        function switchTab(tabName) {
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // Handle file uploads
        function handleFiles(files) {
            if (!currentGroupId) {
                alert('Please save the group first before uploading documents');
                return;
            }

            const group = groups.find(g => g.id === currentGroupId);
            if (!group.documents) group.documents = [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const doc = {
                        id: Date.now().toString() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadedAt: new Date().toISOString(),
                        uploadedBy: userName
                    };
                    
                    group.documents.push(doc);
                    saveGroups();
                    renderDocuments(group);
                    addActivity(group, 'upload', `Uploaded document: ${file.name}`);
                };
                reader.readAsDataURL(file);
            });
        }

        // Render documents
        function renderDocuments(group) {
            const container = document.getElementById('documentsList');
            const docs = group.documents || [];
            
            document.getElementById('docCountBadge').textContent = docs.length > 0 ? `(${docs.length})` : '';

            if (docs.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No documents yet</p></div>';
                return;
            }

            container.innerHTML = docs.map(doc => {
                const ext = doc.name.split('.').pop().toUpperCase();
                const size = (doc.size / 1024).toFixed(1) + ' KB';
                const date = new Date(doc.uploadedAt).toLocaleDateString();

                return `
                    <div class="document-item">
                        <div class="document-icon">${ext}</div>
                        <div class="document-info">
                            <div class="document-name">${doc.name}</div>
                            <div class="document-meta">
                                ${size} ‚Ä¢ Uploaded by ${doc.uploadedBy} on ${date}
                            </div>
                        </div>
                        <div class="document-actions">
                            <button class="icon-btn" onclick="downloadDocument('${group.id}', '${doc.id}')" title="Download">
                                ‚¨áÔ∏è
                            </button>
                            <button class="icon-btn" onclick="deleteDocument('${group.id}', '${doc.id}')" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Download document
        function downloadDocument(groupId, docId) {
            const group = groups.find(g => g.id === groupId);
            const doc = group.documents.find(d => d.id === docId);
            
            const link = document.createElement('a');
            link.href = doc.data;
            link.download = doc.name;
            link.click();
        }

        // Delete document
        function deleteDocument(groupId, docId) {
            if (!confirm('Delete this document?')) return;
            
            const group = groups.find(g => g.id === groupId);
            const doc = group.documents.find(d => d.id === docId);
            group.documents = group.documents.filter(d => d.id !== docId);
            
            saveGroups();
            renderDocuments(group);
            addActivity(group, 'upload', `Deleted document: ${doc.name}`);
        }

        // Add comment
        function addComment() {
            const text = document.getElementById('commentInput').value.trim();
            if (!text) return;

            const group = groups.find(g => g.id === currentGroupId);
            if (!group.comments) group.comments = [];

            const comment = {
                id: Date.now().toString(),
                text: text,
                author: userName,
                timestamp: new Date().toISOString()
            };

            group.comments.push(comment);
            document.getElementById('commentInput').value = '';
            
            saveGroups();
            renderComments(group);
            addActivity(group, 'comment', `Added a comment`);
        }

        // Render comments
        function renderComments(group) {
            const container = document.getElementById('commentsList');
            const comments = group.comments || [];
            
            document.getElementById('commentCountBadge').textContent = comments.length > 0 ? `(${comments.length})` : '';

            if (comments.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No comments yet</p></div>';
                return;
            }

            container.innerHTML = comments.map(comment => {
                const date = new Date(comment.timestamp);
                const timeAgo = getTimeAgo(date);

                return `
                    <div class="comment-item">
                        <div class="comment-avatar">${comment.author.charAt(0).toUpperCase()}</div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">${comment.author}</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-text">${comment.text}</div>
                            <div class="comment-actions">
                                <span class="comment-action" onclick="deleteComment('${group.id}', '${comment.id}')">Delete</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Delete comment
        function deleteComment(groupId, commentId) {
            if (!confirm('Delete this comment?')) return;
            
            const group = groups.find(g => g.id === groupId);
            group.comments = group.comments.filter(c => c.id !== commentId);
            
            saveGroups();
            renderComments(group);
        }

        // Add activity
        function addActivity(group, type, description) {
            if (!group.activity) group.activity = [];
            
            group.activity.unshift({
                id: Date.now().toString(),
                type: type,
                description: description,
                user: userName,
                timestamp: new Date().toISOString()
            });

            // Keep only last 50 activities
            if (group.activity.length > 50) {
                group.activity = group.activity.slice(0, 50);
            }
        }

        // Render activity
        function renderActivity(group) {
            const container = document.getElementById('activityList');
            const activities = group.activity || [];

            if (activities.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No activity yet</p></div>';
                return;
            }

            container.innerHTML = activities.map(activity => {
                const date = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(date);
                
                let iconClass = 'edit';
                let icon = '‚úèÔ∏è';
                
                if (activity.type === 'upload') {
                    iconClass = 'upload';
                    icon = 'üìÑ';
                } else if (activity.type === 'comment') {
                    iconClass = 'comment';
                    icon = 'üí¨';
                } else if (activity.type === 'deadline') {
                    iconClass = 'deadline';
                    icon = '‚è∞';
                }

                return `
                    <div class="activity-item">
                        <div class="activity-icon ${iconClass}">${icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <strong>${activity.user}</strong> ${activity.description}
                            </div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            
            return date.toLocaleDateString();
        }

        // Export data
        // Export data as JSON backup
        function exportData() {
            const dataToExport = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                groups: groups
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `booking-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('üì• Backup downloaded successfully!');
        }

        // Import data from backup
        function importData() {
            document.getElementById('importFileInput').click();
        }

        // Handle import file selection
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                alert('Please select a valid JSON backup file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.groups || !Array.isArray(importedData.groups)) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Ask for confirmation
                    const confirmMsg = `Import ${importedData.groups.length} bookings?\n\nExport Date: ${new Date(importedData.exportDate).toLocaleString()}\n\nThis will replace your current data. Make sure you have a backup first!`;
                    
                    if (!confirm(confirmMsg)) {
                        event.target.value = ''; // Reset file input
                        return;
                    }
                    
                    // Import data
                    groups = importedData.groups;
                    saveGroups();
                    renderGroups();
                    
                    showToast(`‚úÖ Successfully imported ${groups.length} bookings!`);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Failed to import data: ' + error.message);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('Failed to read file');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // Export to CSV (for reports)
        function exportToCSV() {
            const filtered = filterGroups(groups);
            const csv = convertToCSV(filtered);
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `booking-export-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            showToast('üìä CSV report exported!');
        }

        // Convert to CSV
        function convertToCSV(data) {
            const headers = [
                'Group Name', 'Airline', 'Route', 'Departure', 'Return',
                'Passengers', 'Net Price', 'Sale Price', 'Profit', 'Status',
                'Deposit 1', 'Deposit 2', 'Name Deadline', 'Ticketing Deadline'
            ];
            
            const rows = data.map(g => {
                const profit = (parseFloat(g.salePrice) || 0) - (parseFloat(g.netPrice) || 0);
                return [
                    g.name, g.airline, g.route, g.departureDate, g.returnDate,
                    g.passengers, g.netPrice, g.salePrice, profit.toFixed(2), g.status,
                    g.deposit1Date, g.deposit2Date, g.nameDeadline, g.ticketingDeadline
                ].map(v => `"${v || ''}"`).join(',');
            });
            
            return [headers.join(','), ...rows].join('\n');
        }

        // Check notifications
        function checkNotifications() {
            const enabled = localStorage.getItem('notificationsEnabled');
            if (enabled === 'true' && 'Notification' in window && Notification.permission === 'granted') {
                notificationsEnabled = true;
                showNotificationBanner(true);
            } else {
                showNotificationBanner(false);
            }
        }

        // Show notification banner
        function showNotificationBanner(enabled) {
            const banner = document.getElementById('notificationBanner');
            banner.style.display = 'block';
            
            if (enabled) {
                banner.className = 'notification-banner enabled';
                banner.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>‚úÖ</span>
                        <span>Notifications: On</span>
                    </div>
                    <button class="btn-secondary" style="padding: 6px 12px; font-size: 13px;" 
                            onclick="disableNotifications()">Off</button>
                `;
            } else {
                banner.className = 'notification-banner';
                banner.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>üîî</span>
                        <span>Notifications: Off</span>
                    </div>
                    <button class="btn-primary" chip-btn style="padding: 6px 12px; font-size: 13px;" 
                            onclick="enableNotifications()">On</button>
                `;
            }
        }

        // Enable notifications
        function enableNotifications() {
            if (!('Notification' in window)) {
                alert('Your browser does not support notifications');
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    localStorage.setItem('notificationsEnabled', 'true');
                    notificationsEnabled = true;
                    showNotificationBanner(true);
                    
                    new Notification('Group Booking Manager', {
                        body: 'Notifications enabled! You will receive deadline reminders.',
                        icon: '‚úàÔ∏è'
                    });
                }
            });
        }

        // Disable notifications
        function disableNotifications() {
            localStorage.setItem('notificationsEnabled', 'false');
            notificationsEnabled = false;
            showNotificationBanner(false);
        }

        // Initialize app
        init();
    </script>
</body>
</html>